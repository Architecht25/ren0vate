<script>
  window.primes = <%= raw(@primes.to_json(
    only: [:slug, :titre, :unite, :type_de_valeur, :valeurs_par_categorie, :placeholder, :condition, :conseil, :document, :eligible_categories]
  )) %>;

  window.categorieId = "<%= @categorie_id || '3' %>";
  window.plafondsParCategorie = <%= raw(@plafonds_par_categorie.to_json) %>;
  window.groupesPlafond = <%= raw(@groupes_plafond.to_json) %>;
</script>


<div class="container my-5">

  <div class="text-center mb-5">
    <h1 class="display-4">Ren0vate</h1>
    <p class="lead text-muted">Nous allons transformer votre vision sur la mani√®re de demander des primes üè°üí∂</p>
    <p class="lead text-muted">Commencons par le d√©but et testez votre √©ligibilit√© ‚úèÔ∏è</p>
  </div>

  <!-- S√©lecteur de r√©gion -->
  <div class="card mb-4 shadow-sm" data-controller="region-selector">
    <div class="card-body text-center">
      <h3 class="card-title mb-3">Dans quelle r√©gion se situe le bien √† r√©nover ?</h3>
      <div class="btn-group" role="group">
        <button type="button" class="btn btn-outline-primary" data-action="click->region-selector#select" data-region="flandre">Flandre</button>
        <button type="button" class="btn btn-outline-primary" data-action="click->region-selector#select" data-region="wallonie">Wallonie</button>
        <button type="button" class="btn btn-outline-primary" data-action="click->region-selector#select" data-region="bruxelles">Bruxelles</button>
      </div>
    </div>
  </div>

  <!-- Affichage des profils -->
  <div data-controller="region-display">
    <%# Flandre %>
    <div data-region-display-target="flandre" class="d-none" data-controller="user-type">
      <div class="card shadow-sm mb-4">
        <div class="card-body text-center">
          <h4 class="mb-3">Flandre ‚Äì Quel est votre profil ?</h4>
          <div class="btn-group flex-wrap" role="group">
            <button class="btn btn-outline-success m-1" data-action="click->user-type#select" data-user="prive">Particulier</button>
            <button class="btn btn-outline-success m-1" data-action="click->user-type#select" data-user="entreprise">Entreprise</button>
            <button class="btn btn-outline-success m-1" data-action="click->user-type#select" data-user="syndic">Syndic de Copropri√©t√©</button>
            <button class="btn btn-outline-success m-1" data-action="click->user-type#select" data-user="bailleur">Bailleur social</button>
            <button class="btn btn-outline-success m-1" data-action="click->user-type#select" data-user="asbl">ASBL / Coop√©rative</button>
          </div>
        </div>
      </div>
    </div>

    <%# Wallonie %>
    <div data-region-display-target="wallonie" class="d-none">
      <div class="card shadow-sm mb-4">
        <div class="card-body text-center">
          <h4 class="mb-3">Wallonie ‚Äì Quel est votre profil ?</h4>
          <div class="btn-group" role="group">
            <button class="btn btn-outline-success m-1" data-action="click->user-type#select" data-user="prive">Particulier</button>
            <button class="btn btn-outline-success m-1" data-action="click->user-type#select" data-user="entreprise">Entreprise</button>
            <button class="btn btn-outline-success m-1" data-action="click->user-type#select" data-user="syndic">Syndic de Copropri√©t√©</button>
          </div>
        </div>
      </div>
    </div>

    <%# Bruxelles %>
    <div data-region-display-target="bruxelles" class="d-none">
      <div class="card shadow-sm mb-4">
        <div class="card-body text-center">
          <h4 class="mb-3">Bruxelles ‚Äì Quel est votre profil ?</h4>
          <div class="btn-group" role="group">
            <button class="btn btn-outline-success m-1" data-action="click->user-type#select" data-user="prive">Particulier</button>
            <button class="btn btn-outline-success m-1" data-action="click->user-type#select" data-user="entreprise">Entreprise</button>
            <button class="btn btn-outline-success m-1" data-action="click->user-type#select" data-user="syndic">Syndic de Copropri√©t√©</button>
            <button class="btn btn-outline-success m-1" data-action="click->user-type#select" data-user="ais">AIS</button>
            <button class="btn btn-outline-success m-1" data-action="click->user-type#select" data-user="autres">Autres</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Test d‚Äô√©ligibilit√© -->
  <div id="eligibility-test" data-controller="test-eligibilite" class="d-none">
    <div class="card shadow-sm">
      <div class="card-body">
        <h3 class="mb-4">Test d‚Äô√©ligibilit√©</h3>
        <form id="eligibilityForm" name="eligibilityForm" data-test-eligibilite-target="form">
          <%# R√©p√®te cette structure pour chaque step %>
          <% steps = {
            "usage" => "Le bien est-il destin√© √† √™tre habit√© ?",
            "propri√©taire" => "√ätes-vous propri√©taire du bien (min 1%)?",
            "autre_bien" => "Poss√©dez-vous un autre bien/appartement/terrain ?",
            "annee" => "Le logement a-t-il √©t√© construit avant le 1er janvier 2006 ?",
            "appartement" => "Le logement est-il un appartement non soumis √† copropri√©t√© (vma)?",
            "appartement-copro" => "Logement est-il un appartement soumis √† copropri√©t√© (vma)?",
            "immeuble-appartements" => "Le bien est-il un immeuble √† appartements destin√©s au logement?",
            "type" => "Le logement est-il une maison?",
            "peb" => "Le certificat PEB indique-t-il un label E ou F ?",
            "domicile" => "√ätes-vous ou serez-vous domicili√© dans ce logement ?",
            "demolition" => "Le logement est-il un b√¢timent qui a √©t√© d√©moli mais en gardant des r√©sidus pour b√©n√©ficier de la TVA √† 6% ?",
            "travaux" => "Pr√©voyez-vous des travaux d‚Äôisolation ou de chauffage ?",
            "protege" => "√ätes-vous un client prot√©g√© ?"
          } %>

          <% steps.each do |key, question| %>
            <div class="form-card mb-4" data-test-eligibilite-target="formCard">
              <h5><%= question %></h5>
              <div class="form-check">
                <input type="radio" class="form-check-input" name="<%= key %>" value="oui" data-action="click->test-eligibilite#handleAnswer" id="<%= key %>_oui">
                <label class="form-check-label" for="<%= key %>_oui">Oui</label>
              </div>
              <div class="form-check">
                <input type="radio" class="form-check-input" name="<%= key %>" value="non" data-action="click->test-eligibilite#handleAnswer" id="<%= key %>_non">
                <label class="form-check-label" for="<%= key %>_non">Non</label>
              </div>
            </div>
          <% end %>
        </form>

        <div id="result"
          data-test-eligibilite-target="result"
          class="alert alert-info mt-4 text-center"
          style="display: none;">
        </div>

        <div id="affinage-categorie" data-controller="categorie-estimation" class="mt-4 p-3 border rounded bg-light" style="display: none;">
          <h5 class="mb-3">Affinez votre cat√©gorie en pr√©cisant ces √©l√©ments :</h5>

          <!-- Statut du m√©nage -->
          <div class="mb-3">
            <label for="statut-familial" class="form-label">Situation familiale</label>
            <select id="statut-familial" class="form-select" required>
              <option value="">S√©lectionnez une option</option>
              <option value="isol√©">Isol√© / C√©libataire</option>
              <option value="isol√©-enfant">Isol√© avec enfant √† charge</option>
              <option value="couple">Couple sans enfants"</option>
              <option value="couple-enfant">Couple avec enfants √† charge</option>
            </select>
          </div>

          <!-- Nombre de personnes √† charge -->
          <div class="mb-3">
            <label for="personnes-charge" class="form-label">Nombre de personnes √† charge</label>
            <select id="personnes-charge" class="form-select" required>
              <option value="">S√©lectionnez</option>
              <option value="0">0</option>
              <option value="1">1</option>
              <option value="2">2</option>
              <option value="3">3</option>
              <option value="4">4</option>
            </select>
          </div>

          <!-- Revenu imposable net -->
          <div class="mb-3">
            <label for="revenu-net" class="form-label">Revenu imposable globablement du m√©nage</label>
            <select id="revenu-net" class="form-select" required>
              <option value="">S√©lectionnez une tranche</option>
              <option value="-24320">Moins de 24.230 ‚Ç¨</option>
              <option value="24231-42340">24.231 ‚Ç¨ ‚Äì 42.340 ‚Ç¨</option>
              <option value="42341-53880">42.341 ‚Ç¨ ‚Äì 53.880 ‚Ç¨</option>
              <option value="53881+">Plus de 53.881 ‚Ç¨</option>
            </select>
            <p class="mt-3 text-muted small">
              üí° Pour un calcul pr√©cis bas√© sur vos documents fiscaux, cr√©ez un compte ou connectez-vous √† votre espace personnel.
            </p>
          </div>

          <button id="valider-affinage"
                  class="btn btn-success mt-2"
                  data-action="click->categorie-estimation#estimerCategorie">
            Valider et recalculer ma cat√©gorie
          </button>


          <!-- R√©sultat de l'estimation -->
          <div id="result-affinage"
               data-categorie-estimation-target="resultAffinage"
               class="alert alert-secondary mt-3 text-center"
               style="display: none;">
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Simulation pr√©alable des primes via les mini cartes primes -->
<div class="container my-5" data-controller="prime-calcul">
  <div class="row g-4">
    <% @primes.each do |prime| %>
      <% if prime.eligible_categories.include?(@categorie_id.to_s) %>
        <div class="col-md-4" data-controller="prime-card" data-slug="<%= prime.slug %>">
          <div class="card shadow-sm border-0 h-100 p-3">
            <div class="card-body d-flex align-items-center gap-3">
              <div class="bg-success bg-opacity-10 rounded-circle d-flex align-items-center justify-content-center" style="width: 70px; height: 70px;">
                <i class="bi bi-<%= prime.icon_name %> fs-3 text-success"></i>
              </div>
              <h5 class="card-title mb-0"><%= prime.titre %></h5>
            </div>

            <div class="px-3 pb-3">
              <% if prime.slug == "warmtepomp" %>
                <div class="d-flex justify-content-between align-items-center gap-2">
                  <!-- S√©lecteur -->
                  <select class="form-select w-50"
                          data-action="change->prime-card#update"
                          data-prime-card-target="select">
                    <option value="">Choisissez le type de pompe</option>
                    <option value="geothermique">geothermique</option>
                    <option value="air_eau">air eau</option>
                    <option value="air_air">air air</option>
                    <option value="hybride">hybride</option>
                  </select>

                  <!-- Montant -->
                  <span class="input-group-text bg-success text-white prime-result w-50 text-center"
                        data-slug="<%= prime.slug %>">
                    0 ‚Ç¨
                  </span>
                </div>

              <% else %>
                <!-- Carte classique avec champ input -->
                <div class="input-group">
                  <input type="number"
                        class="form-control prime-input"
                        style="width: 50%;"
                        data-prime-card-target="input"
                        data-action="input->prime-card#update"
                        value="0"
                        placeholder="<%= prime.placeholder[@categorie_id.to_s] %>">
                  <span class="input-group-text bg-success text-white prime-result"
                        data-slug="<%= prime.slug %>"
                        style="width: 50%; text-align: center;">
                    0 ‚Ç¨
                  </span>
                </div>
              <% end %>
            </div>
          </div>
        </div>
      <% end %>
    <% end %>
  </div>
</div>


    <div class="text-end mt-4 fw-bold fs-5">
      Total estim√© des primes : <span id="total-primes-affiche">0.00 ‚Ç¨</span>
    </div>
  </div>

  <!-- lien vers la liste des primes en flandre -->
  <div class="text-center mb-5">
    <%= link_to "Voir la liste des primes en Flandre", primes_path, class: "btn btn-outline-danger mt-3" %>
    <%= link_to "Voir la liste des cat√©gories de revenus en Flandre", categories_path, class: "btn btn-outline-danger mt-3" %>
  </div>

  <!-- lien vers le login apr√®s le test d'√©ligibilit√© et le simulateur de primes -->
  <div class="text-center mb-5">
    <button type="button" class="btn btn-outline-primary">Se connecter pour sauvegarder votre simulation</button>
  </div>

  <!-- lien pour surveiller le localStorage -->
  <div class="text-center mb-5">
    <%= link_to "Surveiller le localStorage", localstorage_path, class: "btn btn-outline-info mt-3" %>
  </div>

</div>

<script>
  console.log("üîç Structure de window.primes:", window.primes);
</script>

<% @primes.each do |prime| %>
  <script>
    console.log("üîç Prime slug:", "<%= prime.slug %>");
  </script>
<% end %>
